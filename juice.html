<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="sidebar.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $.getJSON('check_session.php', function(data) {
                if (!data.sessionSet) {
                    window.location.href = 'login.html';
                } else {
                    // Update the button text with the session value
                    $('#sidebarToggle').text('☰ ' + data.sessionValue);
                }
            });
        });
    </script>
    <title>Fruit Sales Inventory Management System</title>
    <style>
       body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        #sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        #sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 25px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        #sidebar a:hover {
            color: #f1f1f1;
        }

        #sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }

        #sidebarToggle {
            font-size: 30px;
            cursor: pointer;
        }

        #main {
            transition: margin-left .5s;
            padding: 16px;
        }

        table {
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #333;
            color: white;
        }

        table thead, table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }

        .output {
            max-height: 200px;
            overflow-y: auto;
        }
        #popup2 { position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background-color: #fff; 
            padding: 20px; 
            border: 1px solid #000; 
            display: none; 
        }
      /* General table style */
       /* General table style */
       tbody {
            display: block;
            max-height: 300px; /* Set a maximum height */
            overflow-y: auto; /* Add a scrollbar if the content exceeds the height */
            overflow-x: hidden; /* Hide horizontal scrollbar */
        }

        /* Popup table style */
        #popup {
            position: fixed;
            width: 70%;
            height: 70%;
            top: 50%;
            left: 30%;
            margin-top: -200px;
            margin-left: -250px;
            background-color: rgb(179, 127, 238);
            border: 5px solid #3c5664;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 5px;
            display: none;
            overflow: auto; /* Add this to make the popup scrollable */
            z-index: 1000; 
        }

        #popup .table_container {
            max-height: 100%; 
            overflow: auto;
            overflow-x: hidden; /* Hide horizontal scrollbar */
        }

        #popup input[type="text"],
        #popup input[type="number"] {
            width: 70%;
            margin-bottom: 1px;
            padding: 5px;
        }

        #popup-controls {
            margin-top: 3%;
            display: flex;
            justify-content: end;
        }

        #popup-controls button {
            margin-left: 5px;
        }

        #popup-header {
            height: 50px; /* Adjust as needed */
        }

        #popup-body {
            height: auto; /* Adjust as needed */
            margin-bottom: -10px; /* Adjust as needed */
            overflow-y: auto; /* Add a scrollbar if the content exceeds the height */
        }

        /* Add a style for the table body */
        #popup-body table {
            width: 100%; /* Make the table take up the full width of the popup body */
            border-collapse: collapse; /* Remove space between table cells */
        }

        #popup-body table th,
        #popup-body table td {
            border: 1px solid #ccc; /* Add a border to table cells */
            padding: 5px; /* Add some padding to table cells */
        }

        #popup-body table tr:nth-child(even) {
            background-color: #f2f2f2; /* Add a background color to even rows */
        }

        #popup tbody {
            display: block;
            height: auto; /* Set a small height using rem */
            overflow-x: hidden; /* Hide horizontal scrollbar */
        }

    </style>
</head>

<body>
    <div id="sidebar">
        <a href="index.html" id="Dashboardlink">Dashboard</a>
        <a href="fruit.html" id="fruitLink">fruit</a>
        <a href="juice.html" id="juiceLink">juice</a>
        <a href="expence.html" id="expenceLink">expence</a>
        <a href="sales.html" id="salesLink">sales</a>
        <button onclick="logout()">Logout</button>
    </div>
    <div id="main">
        <button id="sidebarToggle" onclick="toggleNav()">☰</button>
        <div class="top-container">
        <section id="rawMaterialSection" class="card">
            <h2>Raw Materials</h2>
            <form id="rawMaterialForm">
                <label for="rawMaterialName">Material Name:</label>
                <input type="text" id="rawMaterialName" required>
                <label for="rawMaterialQuantity">Quantity:</label>
                <input type="number" step="0.01" id="rawMaterialQuantity" required>
                <label for="rawMaterialprice">price:</label>
                <input type="number" step="0.01" id="rawMaterialprice" required>
                <button type="submit" onclick="addRawMaterial()">Add Raw Material</button>
            </form>
        </section>

        <section id="salesSection" class="card">
            <h2>Sales</h2>
            <form id="sellItemForm">
                <label for="sellItemId">Select Item:</label>
                <select id="sellItemId">
                    <option value="" disabled selected hidden>Select a the combinations</option>
                </select>      
                <label for="maxQuantity">available Quantity:</label>
                <input type="number" id="maxQuantity" readonly>
                <label for="sellQuantity">Quantity:</label>
                <input type="number" id="sellQuantity" required>  
                <button type="submit" onclick="sellItem()">Sell Item</button>
            </form>
        </section>

        <!-- Modified Losses Section -->
        <section id="lossesSection" class="card">
            <h2>Losses Management</h2>
            <form id="recordLossForm">
                <label for="lossItemId">Select Item:</label>
                <select id="lossItemId">
                    <option value="" disabled selected hidden>Select a raw material</option>
                </select>
                <label for="avalQuantity">available Quantity:</label>
                <input type="number" id="avalQuantity" readonly>
                <label for="lossQuantity">Quantity:</label>
                <input type="number" step="0.001" id="lossQuantity" required>
                <label for="lossReason">Reason:</label>
                <input type="text" id="lossReason" required>
                <button type="submit"onclick="recordLoss()">Record Loss</button>
            </form>
        </section>
        </div>
        <section id="combinationtable" class="card">
            <table id="combinationTable">
                <thead>
                    <tr>
                        <th>combination name</th>
                        <th>Raw Materials ID</th>
                        <th>Raw Materials</th>
                        <th>Raw Materials Quantity</th>
                        <th>Raw materials selling price</th>
                        <th>actions</th>
                    </tr>
                </thead>
                <tbody id="combinationTablebody">
                    <!-- Raw material rows will be dynamically added here -->
                </tbody>
            </table>
        </section>


        <section id="combinationSection" class="card">
            <h2>Combinations</h2>
            <form id="combinationForm">
                <label for="combinationName">Combination Name:</label>
                <input type="text" id="combinationName" required>
                <label for="rowItemId">Select row material:</label>
                <select id="rowItemId">
                    <option value="" disabled selected hidden>Select a raw material</option>
                </select>
                <label for="rowavailableQuantity">Selected available row material quantity:</label>
                <input type="text" id="rowavailableQuantity" readonly>
                <label for="rowstockprice">Selected row matrial stock price:</label>
                <input type="number" step="0.01" id="rowstockprice" readonly>
                <label for="rowquantity">input row-material quantity:</label>
                <input type="number" step="0.01" id="rowquantity" >
                <label for="rowsellingprice">input row-material selling price:</label>
                <input type="number" step="0.01" id="rowsellingprice" >
                <button type="submit" onclick="addCombination()">Add Combination</button>
            </form>
             
            <table id="rawMaterialTable">
                <thead>
                    <tr>
                        <th>combination name</th>
                        <th>Row id</th>
                        <th>Row Material</th>
                        <th>Quantity</th>
                        <th>price</th>
                    </tr>
                </thead>
                <tbody id="rawMaterialTableBody" style="height: 0; overflow-y: auto;">
                    <!-- Raw material rows will be dynamically added here -->
                </tbody>
            </table>
            <button type="button" onclick="submitCombination()">Submit Combination</button> <!-- New button -->
        </section>
        

        <section id="inventorySection" class="card">
            <h2>Row Materials</h2>
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Material ID</th>
                        <th>Material Name</th>
                        <th>Quantity</th>
                        <th>price</th>
                        <th>total</th>
                        <th>actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody"></tbody>
            </table>
        </section>

        <section id="salesAndLossesSection" class="card">
            <h2>Sales and Losses Log</h2>
            <table id="salesAndLossesTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Action</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Reason</th>
                        <th>selling price</th>
                    </tr>
                </thead>
                <tbody id="salesAndLossesTableBody"></tbody>
            </table>
        </section>
    </div>

    </div>  
    <div id="popup2">
        <label for="popup2-id">ID</label>
        <input id="popup2-id" readonly>
        <label for="popup2-name">Name</label>
        <input id="popup2-name" type="text" pattern="\\D+" title="Please enter a string">
        <label for="popup2-quantity">Quantity</label>
        <input id="popup2-quantity" type="number"required pattern="\\d+(\\.\\d+)?" title="Please enter a decimal number or integer">
        <label for="popup2-price">Price</label>
        <input id="popup2-price" type="number"required pattern="\\d+(\\.\\d+)?" title="Please enter a decimal number or integer">
        <button id="submitBtn">Submit</button>
        <button id="closeBtn">Close</button>
    </div>
    <div id="popup" style="display: none;">
        <div class="table_container">
            <table id="popup-header">
                <h2>Combination Details</h2>
                <thead>
                    <tr class="header-row"> <!-- Add class here -->
                        <th>ID</th>
                        <th>Name</th>
                        <th>rowmatrials</th>
                        <th>quantity</th>
                        <th>price</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="height: 1rem;"> <!-- Set a default height here -->
                        <td><input id="popup-id" readonly></td>
                        <td><input id="popup-name" type="text" pattern="\\D+" title="Please enter a string"></td>
                        <td><input id="popup-Raw-material-ID" readonly></td>
                        <td><input id="popup-Raw-material" readonly></td>
                        <td><input id="popup-quantity" readonly></td>
                        <td><input id="popup-price" readonly></td>
                    </tr>
                </tbody>
            </table>
            <h2 style="margin-top: 1%;">Raw Material details</h2>
        </div>
        <div id="popup-body">
            <!-- The data for each inventory in the combination will be added here dynamically -->
        </div>
        <div id="popup-controls">
            <button id="addInventoryBtn">Add Inventory</button>
            <button id="submitBtnpopupcombination">Submit</button>
            <button id="closeBtnpopupcombination">Close</button>
        </div>
    </div>
    
    
    
    <script>
        // Get the current page filename (e.g., "fruit.html")
        var currentPage = location.pathname.split("/").slice(-1)[0];

        // Function to set the background color and disable the link for the current page
        function setCurrentPageStyle() {
            var navLinks = document.querySelectorAll("#sidebar a");

            // Reset styles for all links
            navLinks.forEach(function (link) {
                link.style.backgroundColor = "";
                link.style.pointerEvents = "auto";
            });

            // Set styles for the current page
            if (currentPage === "juice.html") {
                document.getElementById("juiceLink").style.backgroundColor = "green";
                document.getElementById("juiceLink").style.pointerEvents = "none"; // Disable the link
            }
        }

        // Call the function on page load
        setCurrentPageStyle();
        document.addEventListener("DOMContentLoaded", function () {
            loadInventory();
            displayInventory();
            displaySalesAndLosses();
            loadCombinations();
            loadLossesDropdown();
            displaycombinations();

        // Update the available quantity when the selected option changes
        document.getElementById('lossItemId').addEventListener('change', updateAvalQuantity);
        });

        function addRawMaterial() {
            var itemName = document.getElementById('rawMaterialName').value;
            var quantity = document.getElementById('rawMaterialQuantity').value;
            var price = document.getElementById('rawMaterialprice').value;

            // Check if any of the inputs are empty or zero
            if (!itemName || !quantity || !price || quantity == 0 || price == 0) {
               alert("Inputs cannot be empty or zero.");
                return; // Exit the function
            } else {
                sendData('addRawMaterial', { itemName, quantity, price }, function () {
                    displayInventory();
                });

                console.log("add item called ended");
            }
        }

        function sendData(section, data, callback) {
                console.log('Sending data:', data);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'test.php', true);

                // Set the content type to application/x-www-form-urlencoded
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4) {
                        console.log('Response:', xhr.responseText);
                        if (xhr.status == 200) {
                            try {
                                var responseData = JSON.parse(xhr.responseText);
                                console.log('Parsed Response:', responseData);
                                alert('Server Response: ' + xhr.responseText); // Display server response
                                // Check if handleResponse function exists before calling it
                                if (typeof handleResponse === 'function') {
                                    handleResponse(section);
                                }
                                if (typeof callback === 'function') {
                                    callback(responseData);
                                }
                            } catch (error) {
                                console.error('Error parsing JSON:', error);
                                alert('Error parsing JSON');
                            }
                        } else {
                            console.error('Request failed with status:', xhr.status);
                            alert('Request failed with status: ' + xhr.status);
                        }
                    }
                };

                // Convert the data object to a URL-encoded string
                var encodedData = encodeData(data);

                xhr.send(encodedData);
            }

function handleResponse(section) {
    // You can customize this function based on your needs
    console.log(`Response for section '${section}' handled.`);
    alert(`Response for section '${section}' handled.`);
}

        function encodeData(data) {
            return Object.keys(data).map(function (key) {
                return encodeURIComponent(key) + '=' + encodeURIComponent(data[key]);
            }).join('&');
        }

        function loadCombinations() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'get_combinations.php', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var responseData = JSON.parse(xhr.responseText);
                    console.log('Received data:', responseData); // Log the received data
                    var select = document.getElementById('sellItemId');
                    select.innerHTML = ""; // Clear the select options
                    for (var i = 0; i < responseData.length; i++) {
                        var opt = document.createElement('option');
                        opt.value = responseData[i].id; // Set the value to the id
                        opt.innerHTML = responseData[i].name; // Set the innerHTML to the name
                        opt.setAttribute('availableQuantity', responseData[i].maxQuantity); // Set the availableQuantity attribute
                        select.appendChild(opt);
                    }
                    updateMaxQuantity(); // Update the max quantity for the initially selected option
                }
            };

            xhr.send();
        }

        function updateMaxQuantity() {
            var select = document.getElementById('sellItemId');
            var input = document.getElementById('maxQuantity'); // Assuming you have an input element with id 'maxQuantity'
            var selectedOption = select.options[select.selectedIndex];
            var maxQuantity = selectedOption.getAttribute('availableQuantity');
            input.value = maxQuantity;
        }
        // Update the max quantity when the selected option changes
        document.getElementById('sellItemId').addEventListener('change', updateMaxQuantity);

        function sellItem() {
            console.log("sell");
            
            var combinationId = Number(document.getElementById('sellItemId').value);
            var quantity = Number(document.getElementById('sellQuantity').value);
            var maxq = Number(document.getElementById('maxQuantity').value);

            console.log(combinationId+quantity);
            if (!combinationId || !quantity || !maxq  || quantity == 0 || maxq == 0) {
                alert("Inputs cannot be empty or the values 0.");
                return; // Exit the function
            } else if (quantity > maxq) {
                alert('The quantity being inserted is greater than the available quantity.');
                return; // Exit the function
            } else {
                console.log('trying:');
                var data = {
                    combinationId: combinationId,
                    quantity: quantity
                };
                console.log('Sending data:', data);
                sendDatas('sellItem', data, function (responseData) {
                    // Handle the server's response
                    alert("Server response:", responseData);
                    // Perform additional actions based on the response
                });
            }

        }

    function sendDatas(section, data, callback) {
        console.log('Sending data:', data);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'get_combinations.php', true);

        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                console.log('Response:', xhr.responseText);
                if (xhr.status == 200) {
                    try {
                        var responseData = JSON.parse(xhr.responseText);
                        console.log('Parsed Response:', responseData);
                        if (typeof handleResponse === 'function') {
                            handleResponses(section);
                        }
                        if (typeof callback === 'function') {
                            callback(responseData);
                        }
                    } catch (error) {
                        console.log('Error parsing JSON:', error);
                        alert('Error parsing JSON');
                    }
                } else {
                    console.log('Request failed with status:', xhr.status);
                    alert('Request failed with status: ' + xhr.status);
                }
            }
        };

        var jsonData = JSON.stringify(data);

        xhr.send(jsonData);
    }
/////////////////////////////////////////////////////
// Define the loadLossesDropdown function first

function loadLossesDropdown() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'get_losses.php', true);

    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
            var responseData = JSON.parse(xhr.responseText);

            // Check if responseData is an array
            if (Array.isArray(responseData)) {
                var select = document.getElementById('lossItemId');
                select.innerHTML = ""; // Clear the select options

                for (var i = 0; i < responseData.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = responseData[i].id;
                    opt.innerHTML = responseData[i].name;
                    opt.setAttribute('availableQ', responseData[i].quantity);
                    select.appendChild(opt);
                }

                // Update the available quantity for the initially selected option
                updateAvalQuantity();
            } else {
                console.error('Invalid response data:', responseData);
            }
        }
    };

    xhr.send();
}

function updateAvalQuantity() {
    var select = document.getElementById('lossItemId');
    var input = document.getElementById('avalQuantity');
    var selectedOption = select.options[select.selectedIndex];

    // Check if selectedOption is defined before accessing its attributes
    if (selectedOption) {
        var maxQuantity = selectedOption.getAttribute('availableQ');
        console.log('Max Quantity:', maxQuantity); // Log the max quantity
        input.value = maxQuantity;
    }
}

function recordLoss() {
    var rowid = document.getElementById('lossItemId').value;
    var quantity = document.getElementById('lossQuantity').value;
    var lossReason = document.getElementById('lossReason').value;
    var maxq = document.getElementById('avalQuantity').value;

    if (!rowid || !quantity || !lossReason || !maxq ) {
       alert("Inputs cannot be empty or 0.");
        return; // Exit the function
    }else {
        console.log('trying:');
        var data = {
            rowid: rowid,
            quantity: quantity,
            lossReason: lossReason
        };
        console.log('Sending data:', data);
        sendDatal('lossitem', data, function (responseData) {
            // Handle the server's response
            alert("Server response:", responseData);
            // Perform additional actions based on the response
            loadLossesDropdown(); // Reload the dropdown after recording the loss
            fetchInventory();
        });
    }
}
function sendDatal(section, data, callback) {
    console.log('Sending data:', data);

    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'get_losses.php', true);

    xhr.setRequestHeader('Content-Type', 'application/json');

    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4) {
            console.log('Response Status:', xhr.status);
            console.log('Response Text:', xhr.responseText);

            if (xhr.status == 200) {
                // Parse and process the response data
                var responseData = JSON.parse(xhr.responseText);
                if (responseData.dbUpdate == "success") {
                    confirm("Success: Data sent and database updated successfully! Click OK to continue.");
                } else if (responseData.dbUpdate == "failure") {
                    confirm("Failure: Data sent but database update failed. Click OK to continue.");
                }
            } else {
                // Handle error cases
                console.error('Error in AJAX request:', xhr.status);
                confirm("Failure: Error in AJAX request - " + xhr.status + ". Click OK to continue.");
            }
        }
    };

    var jsonData = JSON.stringify(data);
    xhr.send(jsonData);
}


/////////////////////////////////////////////////////

        // Assuming you have a function to fetch the inventory from the server
        function fetchInventory() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'inventory.php', false); // Change this to the URL of your PHP file
            xhr.send();

            if (xhr.status == 200) {
                return JSON.parse(xhr.responseText);
            } else {
                console.error('Error fetching inventory:', xhr.status);
                return [];
            }
        }
        function loadInventory() {
            var select = document.getElementById('rowItemId');
            var inventory = fetchInventory().data;

            console.log('Inventory:', inventory);

            for (var i = 0; i < inventory.length; i++) {
                var option = document.createElement('option');
                option.value = inventory[i].id;
                option.text = inventory[i].name;
                select.appendChild(option);
            }
        }

        document.getElementById('rowItemId').addEventListener('change', function () {
            var selectedItem = this.value;
            var inventory = fetchInventory().data; // Access the 'data' property

            var selectedInventoryItem = inventory.find(function (item) {
                return item.id === selectedItem;
            });

            if (selectedInventoryItem) {
                document.getElementById('rowavailableQuantity').value = selectedInventoryItem.quantity;
                document.getElementById('rowstockprice').value = selectedInventoryItem.price;
            }
        });
        function addCombination() {
            var availableQuantity = parseFloat(document.getElementById('rowavailableQuantity').value);
            var quantity = parseFloat(document.getElementById('rowquantity').value);
            var combinationN = document.getElementById('combinationName').value;
            var rowsellingprice = parseFloat(document.getElementById('rowsellingprice').value);
            var rowstockprice = parseFloat(document.getElementById('rowstockprice').value);

            // Calculate the unit price and the price for the input quantity
            var unitPrice = rowstockprice * quantity;
            if (!availableQuantity || !quantity || !combinationN || !rowsellingprice ||!rowstockprice || quantity == 0 || rowstockprice == 0 || availableQuantity == 0 || rowsellingprice == 0) {
                alert("Inputs cannot be empty or be 0.");
                return; // Exit the function
            } else if (availableQuantity < quantity) {
                alert('The quantity being inserted is greater than the available quantity.');
                return; // Exit the function
            } else if (unitPrice > rowsellingprice ) {
                alert('The price being inserted is less than the stock price.');
                return; // Exit the function
            } else {
                document.getElementById('combinationName').disabled = true;
                document.getElementById('combinationName').readOnly = true;
                var table = document.getElementById('rawMaterialTableBody');
                var row = table.insertRow();

                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);
                var cell5 = row.insertCell(4);

                cell1.innerHTML = combinationN;
                cell2.innerHTML = document.getElementById('rowItemId').value;
                cell3.innerHTML = document.getElementById('rowItemId').options[document.getElementById('rowItemId').selectedIndex].text;
                cell4.innerHTML = quantity;
                cell5.innerHTML = rowsellingprice; // Use the updated selling price

                // Calculate the height of a row
                var rowHeight = row.offsetHeight;

                // Calculate the current height of the table body
                var currentHeight = table.offsetHeight;

                // Set the maximum height of the table body
                var maxHeight = 300;

                // Increase the height of the table body by the height of a row, but not beyond the maximum height
                if (currentHeight + rowHeight <= maxHeight) {
                    table.style.height = (currentHeight + rowHeight) + "px";
                }
                document.getElementById('rowItemId').selectedIndex = 0;
                document.getElementById('rowavailableQuantity').value = '';
                document.getElementById('rowquantity').value = '';
                document.getElementById('rowsellingprice').value = '';
                document.getElementById('rowstockprice').value = '';
            }
        }


        function submitCombination() {
            var cname = document.getElementById('combinationName').value;
            var table = document.getElementById('rawMaterialTable');
            var data = [];

            if (table.rows.length < 0) {
                return;
            }

            for (var i = 1, row; row = table.rows[i]; i++) {
                var name = row.cells[0].innerHTML;
                var rowid = row.cells[1].innerHTML;
                var rawMaterial = row.cells[2].innerHTML;
                var quantity = row.cells[3].innerHTML;
                var price = row.cells[4].innerHTML;

                data.push({
                    name: name,
                    rowid: rowid,
                    rawMaterial: rawMaterial,
                    quantity: quantity,
                    price:price
                });
            }

            sendDatac('addCombination', data, function () {
                clearCombinationForm();
                loadCombinations();
                displaycombinations();
            });

            document.getElementById('combinationName').disabled = false;
            document.getElementById('combinationName').readOnly = false;
        }

        function sendDatac(section, data, callback) {
            console.log('Sending data:', data);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'inventory.php', true);

            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    console.log('Response:', xhr.responseText);
                    if (xhr.status == 200) {
                        try {
                            var responseData = JSON.parse(xhr.responseText);
                            console.log('Parsed Response:', responseData);
                            if (typeof handleResponse === 'function') {
                                handleResponses(section);
                            }
                            if (typeof callback === 'function') {
                                callback(responseData);
                            }
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                            alert('Error parsing JSON');
                        }
                    } else {
                        console.error('Request failed with status:', xhr.status);
                        alert('Request failed with status: ' + xhr.status);
                    }
                }
            };

            var jsonData = JSON.stringify(data);

            xhr.send(jsonData);
        }

        function handleResponses(section) {
            console.log(`Response for section '${section}' handled.`);
        }


    // Function to clear the combination form after submitting data
    function clearCombinationForm() {
        document.getElementById('combinationName').value = '';
        document.getElementById('rowItemId').selectedIndex = 0;
        document.getElementById('rowavailableQuantity').value = '';
        document.getElementById('rowquantity').value = '';
        document.getElementById('rowsellingprice').value = '';
        document.getElementById('rowstockprice').value = '';
        // Clear the raw material table
        var table = document.getElementById('rawMaterialTableBody');
        while (table.firstChild) {
            table.removeChild(table.firstChild);
        }
    }
        // Send the table's data to the server when the submit button is clicked
        document.getElementById('combinationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var table = document.getElementById('rawMaterialTable');
            var data = [];

            // Loop through each row in the table
            for (var i = 1, row; row = table.rows[i]; i++) {
                // Get the raw material and quantity from the row
                var combinationN = row.cells[0].innerHTML;
                var rowid = row.cells[1].innerHTML;
                var rawMaterial = row.cells[2].innerHTML;
                var quantity = row.cells[3].innerHTML;

                data.push({
                    combinationN: combinationN,
                    rowid: rowid,
                    rawMaterial: rawMaterial,
                    quantity: quantity
                });
            }
        });
        async function displaycombinations() {
            // Fetch combination data from the server/database
            const combinationData = await fetchcombinationData();

            // Display combination data in the table
            var combinationTableBody = document.getElementById("combinationTablebody");
            clearTable(combinationTableBody);

            combinationData.forEach(function (item) {
                var row = combinationTableBody.insertRow();
                var nameCell = row.insertCell(0);
                var rawMaterialID = row.insertCell(1);
                var rawMaterialCell = row.insertCell(2);
                var quantityCell = row.insertCell(3);
                var priceCell = row.insertCell(4);

                // Create text fields
                nameCell.textContent = item.name;
                rawMaterialID.textContent=item.rowID;
                rawMaterialCell.textContent = item.rawMaterial;
                quantityCell.textContent = item.quantity;
                priceCell.textContent = item.price;

                // Create edit button for each row
                var editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.onclick = function () {
                    handleEdit(item);
                };
                row.appendChild(editButton);
            });
        }

async function handleEdit(item) {
    // Fetch the combination data for the item
    const response = await fetch('edit_combination.php?identifier=fetchCombinationData&id=' + item.id);
    const data = await response.json();
    
    // Now you have the combination data and the corresponding inventory data
    // You can use this data to populate the fields in your popup
    document.getElementById("popup-id").value = data.combinationData.id;
    var nameInput = document.getElementById("popup-name");
    nameInput.value = data.combinationData.name;
    var rowmaterialsID = document.getElementById("popup-Raw-material-ID");
    rowmaterialsID.value = data.combinationData.rowID;
    var rowmaterials = document.getElementById("popup-Raw-material");
    rowmaterials.value = data.combinationData.rawMaterial;
    var quan = document.getElementById("popup-quantity");
    quan.value = data.combinationData.quantity;
    var pri = document.getElementById("popup-price");
    pri.value = data.combinationData.price;

    // Clear any existing fields in the popup
    var popupBody = document.getElementById("popup-body");
    while (popupBody.firstChild) {
        popupBody.removeChild(popupBody.firstChild);
    }

    // Create a table for displaying row materials, quantities, and prices
    var table = document.createElement("table");

    // Create a row for the header
    var headerRow = table.insertRow();
    var headerMaterialID = headerRow.insertCell(0);
    headerMaterialID.textContent = "MaterialsID";
    var headerMaterial = headerRow.insertCell(1);
    headerMaterial.textContent = "Materials";
    var headerQuantity = headerRow.insertCell(2);
    headerQuantity.textContent = "Quantities";
    var headerPrice = headerRow.insertCell(3);
    headerPrice.textContent = "Prices";
    var headerAction = headerRow.insertCell(4);
    headerAction.textContent = "Action";

    // Split row materials, quantities, and prices by comma
    var MaterialsID = data.combinationData.rowID.split(',');
    var materials = data.combinationData.rawMaterial.split(',');
    var quantities = data.combinationData.quantity.split(',');
    var prices = data.combinationData.price.split(',');

    // Create rows for each material, quantity, and price combination
    for (var i = 0; i < materials.length; i++) {
        var row = table.insertRow();
        var materialIDCell = row.insertCell(0);
        materialIDCell.textContent = MaterialsID[i];
        var materialCell = row.insertCell(1);
        materialCell.textContent = materials[i];
        var quantityCell = row.insertCell(2);
        var quantityInput = document.createElement("input");
        quantityInput.type = "number"; 
        quantityInput.value = quantities[i];
        quantityInput.style.width = "50px";
        quantityCell.appendChild(quantityInput);
        var priceCell = row.insertCell(3);
        var priceInput = document.createElement("input");
        priceInput.type = "number"; 
        priceInput.value = prices[i];
        priceInput.style.width = "50px";
        priceCell.appendChild(priceInput);


        var deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.onclick = function () {
                    // Delete the corresponding row
                    var confirmDelete = confirm("Are you sure you want to delete this row?");
                    if (confirmDelete) {
                        this.parentNode.parentNode.remove();
                    }
                };
        var actionCell = row.insertCell(4);
        actionCell.appendChild(deleteButton);

    }

    popupBody.appendChild(table);
    document.getElementById('submitBtnpopupcombination').addEventListener('click', async function() {
    // Validate and update data
    if (table.rows.length === 1) {
        alert("There must be at least one row to update the database.");
        return;
    }

    const updatedData = Array.from(table.rows).slice(1).reduce((acc, row) => {
        acc.rowID.push(row.cells[0].textContent);
        acc.rawMaterial.push(row.cells[1].textContent);
        acc.quantity.push(row.cells[2].querySelector('input').value);
        acc.price.push(row.cells[3].querySelector('input').value);
        return acc;
    }, {rowID: [], rawMaterial: [], quantity: [], price: []});

    updatedData.id = [document.getElementById("popup-id").value];
    updatedData.name = [nameInput.value];

    console.log("Data to be sent:", updatedData);

    try {
        const response = await fetch('edit_combination.php', {
            method: 'POST',
            body: JSON.stringify(updatedData),
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const responseBody = await response.text();

        if (response.headers.get('content-type').indexOf('application/json') !== -1) {
            const jsonResponse = JSON.parse(responseBody);
            if (jsonResponse.message) {
                alert('Record updated successfully');
                
                loadCombinations();
                displaycombinations();
            } else if (jsonResponse.error) {
                alert('Error updating record: ' + jsonResponse.error);
            }
        } else {
            console.log('Non-JSON Response:', responseBody);
        }
    } catch (error) {
        console.error('There has been a problem with your fetch operation:', error);
    }
});

// Show the popup
document.getElementById("popup").style.display = "block";

}

function deleteRow(rowIndex) {
    var table = document.getElementById("popup-body").getElementsByTagName('table')[0];
    table.deleteRow(rowIndex);
}

    // Show the popup
document.getElementById('addInventoryBtn').addEventListener('click', function() {
    // Fetch all the inventory data from the server
    fetch('edit_combination.php?identifier=fetchAllInventoryData')
    .then(response => response.json())
    .then(function(inventoryData) {
        // Create a second popup with a dropdown list
        var secondPopup = document.createElement("div");
        secondPopup.id = "secondPopup";
        secondPopup.style.position = "fixed";
        secondPopup.style.top = "50%";
        secondPopup.style.left = "50%";
        secondPopup.style.transform = "translate(-50%, -50%)";
        secondPopup.style.backgroundColor = "#f8f9fa";
        secondPopup.style.borderRadius = "5px";
        secondPopup.style.boxShadow = "0 2px 10px rgba(0, 0, 0, 0.1)";
        secondPopup.style.padding = "20px";
        secondPopup.style.zIndex = "1000";
        var dropdown = document.createElement("select");
        dropdown.id = "inventoryDropdown";
        dropdown.style.width = "100%";
        dropdown.style.marginBottom = "10px";
        for (var i = 0; i < inventoryData.length; i++) {
            var option = document.createElement("option");
            option.value = inventoryData[i].id;
            option.text = inventoryData[i].name;
            dropdown.appendChild(option);
        }
        secondPopup.appendChild(dropdown);

        // Create elements to display the quantity and price
        var quantityDisplay = document.createElement("p");
        quantityDisplay.id = "quantityDisplay";
        secondPopup.appendChild(quantityDisplay);

        var priceDisplay = document.createElement("p");
        priceDisplay.id = "priceDisplay";
        secondPopup.appendChild(priceDisplay);

        // Update the display when a different item is selected
        dropdown.addEventListener('change', function() {
            var selectedOption = dropdown.options[dropdown.selectedIndex];
            quantityDisplay.textContent = "Quantity: " + inventoryData[selectedOption.index].quantity;
            priceDisplay.textContent = "Price: " + inventoryData[selectedOption.index].price;
        });

        // Trigger the change event to display the quantity and price of the initially selected item
        dropdown.dispatchEvent(new Event('change'));

        // Create input fields for quantity and price
        var quantityInput = document.createElement("input");
        quantityInput.id = "quantityInput";
        quantityInput.type = "number"; // Set the type to "number"
        quantityInput.placeholder = "Enter quantity";
        quantityInput.style.width = "100%";
        quantityInput.style.marginBottom = "10px";
        secondPopup.appendChild(quantityInput);

        var priceInput = document.createElement("input");
        priceInput.id = "priceInput";
        priceInput.type = "number"; // Set the type to "number"
        priceInput.placeholder = "Enter price";
        priceInput.style.width = "100%";
        priceInput.style.marginBottom = "10px";
        secondPopup.appendChild(priceInput);

        // Create a table to display the added inventories
        var inventoryTable = document.createElement("table");
        inventoryTable.id = "inventoryTable";
        inventoryTable.style.width = "100%";
        inventoryTable.style.borderCollapse = "collapse";
        inventoryTable.style.marginBottom = "10px";
        secondPopup.appendChild(inventoryTable);
        // Create an "Add" button to add the selected inventory to the table
        var addButton = document.createElement("button");
        addButton.textContent = "Add";
        addButton.style.marginRight = "10px";
        addButton.addEventListener('click', function() {
            // Check if the quantity and price inputs are filled
            if (quantityInput.value && priceInput.value) {
                var selectedOption = dropdown.options[dropdown.selectedIndex];
                var row = inventoryTable.insertRow();
                var cell0 = row.insertCell(0);
                cell0.textContent = selectedOption.value;
                var cell1 = row.insertCell(1);
                cell1.textContent = selectedOption.text;
                var cell2 = row.insertCell(2);
                cell2.textContent = quantityInput.value;
                var cell3 = row.insertCell(3);
                cell3.textContent = priceInput.value;
                // Add some styles to the table cells
                cell0.style.border = "1px solid #dee2e6";
                cell0.style.padding = "8px";
                cell1.style.border = "1px solid #dee2e6";
                cell1.style.padding = "8px";
                cell2.style.border = "1px solid #dee2e6";
                cell2.style.padding = "8px";
                cell3.style.border = "1px solid #dee2e6";
                cell3.style.padding = "8px";
                
                var deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.onclick = function () {
                    // Delete the corresponding row
                    var confirmDelete = confirm("Are you sure you want to delete this row?");
                    if (confirmDelete) {
                        this.parentNode.parentNode.remove();
                    }
                };

                var actionCell = row.insertCell(4);
                actionCell.appendChild(deleteButton);

                // Clear the quantity and price inputs
                quantityInput.value = '';
                priceInput.value = '';
            } else {
                alert("Please fill in both the quantity and price.");
            }
        });
        secondPopup.appendChild(addButton);

            // Create a "Submit" button to send the data to the previous popup table
            var submitButton = document.createElement("button");
            submitButton.textContent = "Submit";
            submitButton.style.marginRight = "10px";
            submitButton.addEventListener('click', function() {
            var rows = inventoryTable.getElementsByTagName("tr");
            for (var i = 0; i < rows.length; i++) {
                // Get the data from the table row
                var rowData = [];
                for (var j = 0; j < rows[i].cells.length - 1; j++) { // Exclude the last cell data
                    rowData.push(rows[i].cells[j].textContent);
                }

                // Create a new row in the previous popup table
                var table = document.getElementById("popup-body").getElementsByTagName('table')[0];
                var row = table.insertRow();

                // Add ID and name cells
                for (var j = 0; j < 2; j++) {
                    var cell = row.insertCell();
                    cell.textContent = rowData[j];
                    // Add some styles to the table cells
                    cell.style.border = "1px solid #dee2e6";
                    cell.style.padding = "8px";
                }

                // Create a quantity input cell
                var quantityCell = row.insertCell();
                var quantityInput = document.createElement("input");
                quantityInput.type = "number";
                quantityInput.min = "0";
                quantityInput.required = true;
                quantityInput.value = rowData[2]; // Pre-fill with existing quantity
                quantityInput.style.width = "50px";
                quantityCell.appendChild(quantityInput);

                // Create a price input cell
                var priceCell = row.insertCell();
                var priceInput = document.createElement("input");
                priceInput.type = "number";
                priceInput.min = "0";
                priceInput.required = true;
                priceInput.value = rowData[3]; // Pre-fill with existing price
                priceInput.style.width = "50px";
                priceCell.appendChild(priceInput);

                // Create a delete button cell
                var deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";
                deleteButton.style.cssText = "background-color: #f44336; /* Red */ color: white; border: none; padding: 15px 32px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer;";
                deleteButton.onclick = function () {
                    // Delete the corresponding row
                    this.parentNode.parentNode.remove();
                };
                var actionCell = row.insertCell();
                actionCell.appendChild(deleteButton);
            }

            // Close the second popup
            secondPopup.style.display = "none";
        });



    secondPopup.appendChild(submitButton);
            // Create a "Close" button to close the second popup
            var closeButton = document.createElement("button");
            closeButton.textContent = "Close";
            closeButton.addEventListener('click', function() {
                secondPopup.style.display = "none";
            });
            secondPopup.appendChild(closeButton);

            // Add the second popup to the body of the page
            document.body.appendChild(secondPopup);

            // Show the second popup
            secondPopup.style.display = "block";
        });
    });

        async function deleteRow(material) {
            const confirmDelete = confirm("Are you sure you want to delete this row?");
            
            if (confirmDelete) {
                // Remove the row from the table
                var table = document.getElementById("popup-body").getElementsByTagName('table')[0];
                var rows = table.getElementsByTagName('tr');
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].getElementsByTagName('td')[0].textContent === material) {
                        table.deleteRow(i);
                        break;
                    }
                }

                // Your existing code to delete the row from the database...
            }
        }
        document.getElementById('closeBtnpopupcombination').addEventListener('click', function() {
            document.getElementById("popup").style.display = "none";
        });




        function displayInventory() {
    // Fetch inventory data from the server/database
    fetchInventoryData().then(function (inventoryData) {
        // Display inventory data in the table
        var inventoryTableBody = document.getElementById("inventoryTableBody");
        clearTable(inventoryTableBody);

        inventoryData.forEach(function (item) {
            var row = inventoryTableBody.insertRow();

            // Add cells for each item property
            ['id', 'name', 'quantity', 'price'].forEach(function (property, index) {
                var cell = row.insertCell(index);
                cell.textContent = item[property];
                // Make the id read-only
                if (property !== 'id') {
                    cell.contentEditable = "true";
                }
            });

            // Add cell for total price
            var cell = row.insertCell(4);
            cell.textContent = item.quantity * item.price;
            cell.contentEditable = "true";

            // Add "Edit" button
            var editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.onclick = function() {
                createPopup(row, 'edit');
            };
            row.appendChild(editBtn);
        });
    });
}

function createPopup(row, route) {
    // Get the pop-up div
    var popup = document.getElementById('popup2');

    // Fill the inputs with the row's data
    document.getElementById('popup2-id').value = row.cells[0].textContent;
    document.getElementById('popup2-name').value = row.cells[1].textContent;
    document.getElementById('popup2-quantity').value = row.cells[2].textContent;
    document.getElementById('popup2-price').value = row.cells[3].textContent;

    // Show the pop-up
    popup.style.display = 'block';

    // When the close button is clicked
    document.getElementById('closeBtn').onclick = function() {
        // Hide the pop-up
        popup.style.display = 'none';
    };

    // When the submit button is clicked
    document.getElementById('submitBtn').onclick = function() {
        // Check the data type and the data
        var id = document.getElementById('popup2-id').value;
        var name = document.getElementById('popup2-name').value;
        var quantity = document.getElementById('popup2-quantity').value;
        var price = document.getElementById('popup2-price').value;
        if (name === "" || isNaN(quantity) || isNaN(price)) {
            alert('Invalid input');
            return;
        }
        // Confirm the action
        if (!confirm('Are you sure you want to submit the changes?')) {
            return;
        }
        // Send the updated data to the server
        fetch('edit_delet.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({route: route, id: id, name: name, quantity: quantity, price: price}),
        }).then(function(response) {
            response.text().then(function(text) {
                if (response.ok) {
                    // Update the row's data
                    row.cells[0].textContent = id;
                    row.cells[1].textContent = name;
                    row.cells[2].textContent = quantity;
                    row.cells[3].textContent = price;
                    row.cells[4].textContent = quantity * price;
                    alert(text);
                } else {
                    console.error('Failed to update row with id ' + id);
                    alert(text);
                }
            });
        });
        // Hide the pop-up
        popup.style.display = 'none';
    };
}

    function displaySalesAndLosses() {
        // Fetch sales and losses data from the server/database
        fetchSalesAndLossesData().then(function (data) {
            // Display sales and losses data in the table
            var salesAndLossesTableBody = document.getElementById("salesAndLossesTableBody");
            clearTable(salesAndLossesTableBody);

            data.forEach(function (entry) {
                var row = salesAndLossesTableBody.insertRow();
                row.insertCell(0).textContent = entry.date;
                row.insertCell(1).textContent = entry.action;
                row.insertCell(2).textContent = entry.item_name;
                row.insertCell(3).textContent = entry.quantity;
                row.insertCell(4).textContent = entry.reason;
                row.insertCell(5).textContent = entry.selling_price;
            });
        });
    }
    function clearTable(tableBody) {
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
    }
    function fetchcombinationData() {
        // Make an AJAX request to the server to fetch inventory data
        return fetchDataFromServer("getCombinationData", {});
    }

    function fetchInventoryData() {
        // Make an AJAX request to the server to fetch inventory data
        return fetchDataFromServer("getInventoryData", {});
    }

    function fetchSalesAndLossesData() {
        // Make an AJAX request to the server to fetch sales and losses data
        return fetchDataFromServer("getSalesAndLossesData", {});
    }
    
    function fetchData(url, options) {
        return fetch(url, options)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .catch((error) => {
                console.error("Fetch Error:", error);
                throw error; // re-throw the error to be caught by the next catch block
            });
    }
        
    function fetchDataFromServer(action, data) {
        // Make an AJAX request to the server
        return fetchData(`server.php?action=${action}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
        });
    }
    </script>
</body>
</html>